---
export const prerender = true;

import { getCollection } from 'astro:content';
import DefaultLayout from '../../layouts/DefaultLayout.astro';
import Map from '../../components/Map.astro';
import { formatDate, formatTime, isUpcoming } from '../../utils/date';

export async function getStaticPaths() {
  const events = await getCollection('events', ({ data }) => data.published);
  return events.map((item) => ({
    params: { slug: item.slug },
    props: { item },
  }));
}

const { item } = Astro.props;
const { Content } = await item.render();

const eventIsUpcoming = isUpcoming(item.data.startsAt);
const startDate = new Date(item.data.startsAt);
const endDate = new Date(item.data.endsAt);
const sameDay = startDate.toDateString() === endDate.toDateString();
---

<DefaultLayout 
  title={`${item.data.title} - Eventi Piedelpoggio`} 
  description={`${item.data.title} - ${formatDate(item.data.startsAt)} a ${item.data.place.name}`}
>
  <article class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-8">
      <ol class="flex items-center space-x-2 text-sm text-gray-500">
        <li><a href="/" class="hover:text-primary-600">Home</a></li>
        <li>/</li>
        <li><a href="/eventi" class="hover:text-primary-600">Eventi</a></li>
        <li>/</li>
        <li class="text-gray-900">{item.data.title}</li>
      </ol>
    </nav>

    <!-- Header dell'evento -->
    <header class="mb-8">
      <div class="mb-4 flex items-center gap-2">
        <span class={`inline-block px-3 py-1 rounded-full text-sm font-medium ${
          eventIsUpcoming 
            ? 'bg-green-100 text-green-800' 
            : 'bg-gray-100 text-gray-800'
        }`}>
          {eventIsUpcoming ? 'Prossimo Evento' : 'Evento Passato'}
        </span>
      </div>
      
      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6">
        {item.data.title}
      </h1>

      <!-- Informazioni evento -->
      <div class="bg-gray-50 rounded-lg p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Data e ora -->
          <div>
            <h3 class="font-semibold text-gray-900 mb-2">üìÖ Quando</h3>
            <div class="text-gray-700">
              {sameDay ? (
                <div>
                  <div class="font-medium">{formatDate(startDate)}</div>
                  <div class="text-sm">
                    {formatTime(startDate)} - {formatTime(endDate)}
                  </div>
                </div>
              ) : (
                <div>
                  <div>Dal {formatDate(startDate)} alle {formatTime(startDate)}</div>
                  <div>Al {formatDate(endDate)} alle {formatTime(endDate)}</div>
                </div>
              )}
            </div>
          </div>

          <!-- Luogo -->
          <div>
            <h3 class="font-semibold text-gray-900 mb-2">üìç Dove</h3>
            <div class="text-gray-700">
              <div class="font-medium">{item.data.place.name}</div>
              <div class="text-sm text-gray-500">
                Piedelpoggio, Leonessa (RI)
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Contenuto dell'evento -->
    <div class="prose prose-lg max-w-none mb-8">
      <Content />
    </div>

    <!-- Mappa interattiva -->
    <div class="mb-8">
      <h3 class="text-xl font-semibold text-gray-900 mb-4">üìç Dove Si Svolge</h3>
      <Map 
        lat={item.data.place.lat} 
        lon={item.data.place.lon} 
        zoom={16}
        height="400px"
        className="mb-4"
      />
      <div class="text-sm text-gray-600 text-center">
        <strong>{item.data.place.name}</strong> - Coordinate: {item.data.place.lat}, {item.data.place.lon}
      </div>
    </div>

    <!-- Footer dell'evento -->
    <footer class="mt-12 pt-8 border-t border-gray-200">
      <div class="flex justify-center">
        <a 
          href="/eventi" 
          class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium"
        >
          ‚Üê Torna agli eventi
        </a>
      </div>
    </footer>
  </article>
</DefaultLayout>